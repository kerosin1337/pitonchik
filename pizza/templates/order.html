{% extends 'base.html' %}
{% load bootstrap4 %}
{% load static %}

{% block content %}
    <main class="container-fluid mb-5">
        <div class="row justify-content-center">
            {% if order.status != 'new' %}
                <div class="col-md-4 ">
                    <form method="post" class="mt-5 shadow-lg p-3 bg-white rounded"
                          action="{% url 'accept' %}"
                          autocomplete="off" id="main">
                        {% csrf_token %}
                        {% verbatim %}
                        <div>
                            <div class="alert alert-danger alert-dismissible" role="alert" id="err" v-if="seen">
                                <button class="close" type="button" data-dismiss="alert" aria-label="close"
                                        @click="seen=false">
                                    ×
                                </button>
                                {{ error }}
                            </div>
                            <h2 class="mb-3">Выбор доставки</h2>
                            <div id="street">
                                <div class="form-group">
                                    <label for="tel" class="form-label">
                                        Телефон
                                    </label>
                                    <input type="text" name="tel"
                                           class="form-control"
                                           placeholder="8-999-999-99-99"
                                           id="tel"
                                           pattern="[0-9]{1}-[0-9]{3}-[0-9]{3}-[0-9]{2}-[0-9]{2}"
                                           required>
                                </div>
                                <div v-if="seen">
                                    <label for="address" class="form-label">
                                        Адресс
                                    </label>
                                    <div class="form-group input-group mb-3">
                                        <input type="text" id="address" v-model="search" :value="search"
                                               @change="changeS"
                                               class="form-control"
                                               name="address"
                                               aria-describedby="basic-addon2"
                                               placeholder="Если нет Вашей улицы, то напишите в комметарии"
                                               autocomplete="new_address"
                                               required>
                                        <button type="button" class="input-group-text btn shadow--hover"
                                                id="basic-addon2"
                                                @click="searchStreet()">Найти
                                        </button>

                                        <ul class="list-group w-100">
                                            <a class="list-group-item list-group-item btn btn-white border"
                                               v-for="st in streets"
                                               :key="st.id"
                                               @click="choiceStreet(st.display_name, st.lat, st.lon)"
                                               :class="{ 'text-danger': st.display_name === 'Ничего не найдено.' }">
                                                {{st.display_name}}
                                            </a>
                                        </ul>
                                        <input type="hidden" :value="dist" name="distance">

                                    </div>

                                    <div class="d-flex justify-content-between">
                                        <div class="form-group" style="width:30%">
                                            <label for="entrance" class="form-label">
                                                Подъезд
                                            </label>
                                            <input type="text" name="entrance"
                                                   class="form-control"
                                                   id="entrance"
                                                   required>
                                        </div>
                                        <div class="form-group" style="width:30%">
                                            <label for="floor_number" class="form-label">
                                                Этаж
                                            </label>
                                            <input type="text" name="floor_number"
                                                   class="form-control"
                                                   id="floor_number"
                                                   required>
                                        </div>
                                        <div class="form-group" style="width:30%">
                                            <label for="apartment_number" class="form-label">
                                                Квартира
                                            </label>
                                            <input type="text" name="apartment_number"
                                                   class="form-control"
                                                   id="apartment_number"
                                                   required>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="mb-3">
                                <label for="exampleFormControlTextarea1" class="form-label">Комментарий</label>
                                <textarea class="form-control" id="exampleFormControlTextarea1" rows="4"
                                          name="comment"></textarea>
                            </div>

                        </div>
                        {% endverbatim %}

                        {#                            {% if request.user.is_authenticated %}#}
                        {#                            <div class="custom-control custom-checkbox mb-3">#}
                        {#                                <input class="custom-control-input" id="customCheck1" type="checkbox" name="save">#}
                        {#                                <label class="custom-control-label" for="customCheck1">Сохранить данные</label>#}
                        {#                            </div>#}
                        {#                            {% endif %}#}
                        {% verbatim %}
                        <div class="form-group" id="payment">
                            <button type="submit" class="btn btn-primary" :disabled="choice">
                                Перейти к оплате
                            </button>
                            <select class="form-select w-50 d-inline align-middle" name="buying_type" v-model="select"
                                    required>
                                <option value="" disabled>Тип доставки</option>
                                <option value="delivery">Доставка</option>
                                <option value="self">Самовывоз</option>
                            </select>
                        </div>
                        {% endverbatim %}
                    </form>
                </div>
            {% endif %}

            {% verbatim %}
            <div style="width: auto;">
                <aside style="width: auto; height: auto" class="mt-5" id="basket">
                    <table class="table table-white shadow-lg rounded-3">
                        <thead>
                        <tr>
                            <th scope="col">Наименование</th>
                            <th scope="col">Кол-во</th>
                            <th scope="col">Цена</th>
                        </tr>
                        </thead>
                        <tbody>
                        <tr v-for="item in cart.products">
                            <td>{{ item.product.name }}({{ item.size }})</td>
                            <td>{{ item.qty }}</td>
                            <td>{{ item.final_price }}</td>
                        </tr>
                        </tbody>
                    </table>
                </aside>
                {% endverbatim %}
                <aside style="width: auto; height: auto">
                    <form id="payment-form" class="bg-white shadow-lg rounded-3 p-3" name="order"
                          method="post">
                        <div id="card-element">

                        </div>

                        <div id="card-error" role="alert"></div>

                        <div class="d-grid gap-2">
                            <button type="submit" id="card-button" class="btn btn-primary p-1 mt-2"
                                    data-username="{{ request.user }}"
                                    data-secret="{{ client_secret }}">
                                {{ cart.final_price }}
                            </button>
                        </div>
                    </form>
                </aside>
            </div>
        </div>

    </main>
    <script>
        let form = document.getElementById('payment-form');
        const stripe = Stripe('pk_test_51IgOVCHac5lTiSCzXjX8cv5ZO6c09nWXJPW1e21aluE9yVe9gC6majkXIeMqIjCQmQHiidxeUGnpeMEIIl0zoxUA00lgPF48fC');
        const elements = stripe.elements();
        const style = {
            base: {
                color: "#32325d",
            }
        };

        const card = elements.create("card", {style: style});
        card.mount("#card-element");
        card.on('change', function (event) {
            const displayError = document.getElementById('card-errors');
            if (event.error) {
                displayError.textContent = event.error.message;
            } else {
                displayError.textContent = '';
            }
        });
        form.addEventListener('submit', function (ev) {
            ev.preventDefault();
            const clientSecret = document.getElementById('card-button');
            stripe.confirmCardPayment(clientSecret.dataset.secret, {
                payment_method: {
                    card: card,
                    billing_details: {
                        name: document.getElementById('card-button').dataset.username
                    }
                }
            }).then(function (result) {
                if (result.error) {
                    // Show error to your customer (e.g., insufficient funds)
                    console.log(result.error.message);
                } else {
                    // The payment has been processed!
                    if (result.paymentIntent.status === 'succeeded') {
                        function getCookie(name) {
                            let cookieValue = null;
                            if (document.cookie && document.cookie !== '') {
                                const cookies = document.cookie.split(';');
                                for (let i = 0; i < cookies.length; i++) {
                                    const cookie = cookies[i].trim();
                                    // Does this cookie string begin with the name we want?
                                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                                        break;
                                    }
                                }
                            }
                            return cookieValue;
                        }

                        const csrftoken = getCookie('csrftoken');
                        const formData = new FormData(document.forms.order);

                        // добавить к пересылке ещё пару ключ - значение
                        formData.append("first_name", document.getElementById('card-button').dataset.username);
                        formData.append("csrfmiddlewaretoken", csrftoken)
                        const xhr = new XMLHttpRequest();
                        xhr.open("POST", "/payed-online-order/");
                        xhr.send(formData);
                        xhr.onreadystatechange = function () {
                            if (xhr.readyState == 4) {
                                window.location.replace("http://127.0.0.1:8000");
                                alert('Ваш заказ успешно оплачен! Менеджер с Вами свяжется')
                            }
                        }
                    }
                }
            });
        });


    </script>
{% endblock %}